<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Submit Work Report</title>
  <link rel="icon" href="img/Emnas Tech.png">
  <style>
    body { font-family: Arial, sans-serif; padding:20px; text-align:center; }
    table { margin: 0 auto; border-collapse: collapse; width: 98%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    input, textarea { padding:8px; width:280px; }
    .btn { padding:8px 14px; background:#01578d; color:#fff; border:0; border-radius:4px; cursor:pointer; }
    .msg { margin-top:10px; }
  </style>
</head>
<body>
  <center><br>
    <img src="img/Emnas Tech.png" alt="" width="120">
    <h1 style="color: rgb(1, 85, 141);">EMNAS TECHNOLOGIES</h1>
    <h2>GRANITE DESIGN â€“ WORK REPORT</h2>
  </center>
  <h2>Submit Work Report</h2>
  <div id="userInfo">Logged in as: <strong id="usernameTxt"></strong></div>

  <form id="reportForm" onsubmit="return false;">
    <table>
      <tr><td>Date :</td><td><input type="date" id="date"></td></tr>
      <tr><td>No. of files :</td><td><input type="number" id="noOfFiles"></td></tr>
      <tr><td>Total sqft :</td><td><input type="text" id="totalSqft"></td></tr>
      <tr><td>DXF :</td><td><input type="text" id="dxf"></td></tr>
      <tr><td>DWG :</td><td><input type="text" id="dwg"></td></tr>
      <tr><td>Lot file number :</td><td><input type="text" id="lotFileNumber"></td></tr>
      <tr><td>Lot sqft :</td><td><input type="text" id="lotSqft"></td></tr>
      <tr><td>Lot template :</td><td><input type="text" id="lotTemplate"></td></tr>
      <tr><td>Lot units :</td><td><input type="text" id="lotUnits"></td></tr>
      <tr><td>Notes :</td><td><textarea id="notes"></textarea></td></tr>
      <tr><td></td><td><button class="btn" id="submitBtn">Save</button></td></tr>
    </table>
  </form>
  <div class="msg" id="msg"></div>

  <h3>My Reports</h3>
  <div style="margin-bottom:10px;">
    From: <input type="date" id="fromDate">
    To: <input type="date" id="toDate">
    <button class="btn" onclick="applyFilter()">Filter</button>
    <button class="btn" onclick="clearFilter()">Clear</button>
  </div>
  <table id="myReportsTable"></table>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxmzxIDOvgl1YtLZ1i26JLPpItzC5OHurUPyMCGtLQRn7nyRZAeElP0m6hWGCO5QnHt/exec';
const user = localStorage.getItem('gd_username');
if (!user) {
  alert('Please login first');
  location.href = 'Login.html';
}
document.getElementById('usernameTxt').innerText = user;

const msg = document.getElementById('msg');
let allReportsData = [];

async function loadMyReports() {
  try {
    const res = await fetch(`${API_URL}?username=${encodeURIComponent(user)}`);
    const data = await res.json();
    if (!data.ok) {
      document.getElementById('myReportsTable').innerHTML = '<tr><td>Error loading</td></tr>';
      return;
    }
    allReportsData = data.reports;
    renderTable(data.header, allReportsData);
  } catch (err) {
    document.getElementById('myReportsTable').innerHTML = '<tr><td>Error: ' + err.toString() + '</td></tr>';
  }
}

function applyFilter() {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  const filtered = allReportsData.filter(r => {
    const d = r.row[1];
    if (!d) return false;
    // r.row[1] expected as 'YYYY-MM-DD'
    if (from && d < from) return false;
    if (to && d > to) return false;
    return true;
  });
  renderTable(getHeaders(), filtered);
}

function clearFilter() {
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';
  renderTable(getHeaders(), allReportsData);
}

function getHeaders() {
  return ['Username','Date','NoOfFiles','TotalSqft','DXF','DWG','LotFileNumber','LotSqft','LotTemplate','LotUnits','Notes'];
}

function renderTable(header, reports) {
  const table = document.getElementById('myReportsTable');
  if (!reports.length) {
    table.innerHTML = '<tr><td>No reports found</td></tr>';
    return;
  }
  let html = '<tr>' + header.map(h => `<th>${h}</th>`).join('') + '<th>Actions</th></tr>';
  reports.forEach(r => {
    html += '<tr>' +
      r.row.map((c, i) => `<td>${i===1 ? (formatDateForDisplay(c)) : (c || '')}</td>`).join('') +
      `<td>
        <button onclick="editReport(${r.rowIndex})">Edit</button>
        <button onclick="deleteReport(${r.rowIndex})">Delete</button>
      </td>` +
      '</tr>';
  });
  table.innerHTML = html;
}

function formatDateForDisplay(val) {
  if (!val) return '';
  if (typeof val === 'string' && val.includes('T')) return val.split('T')[0];
  return val; // already 'YYYY-MM-DD' or other string
}

async function editReport(rowIndex) {
  try {
    const res = await fetch(`${API_URL}?username=${encodeURIComponent(user)}`);
    const data = await res.json();
    const report = data.reports.find(r => r.rowIndex === rowIndex);
    if (!report) return;

    document.getElementById('date').value = formatDateForDisplay(report.row[1]) || '';
    document.getElementById('noOfFiles').value = report.row[2] || '';
    document.getElementById('totalSqft').value = report.row[3] || '';
    document.getElementById('dxf').value = report.row[4] || '';
    document.getElementById('dwg').value = report.row[5] || '';
    document.getElementById('lotFileNumber').value = report.row[6] || '';
    document.getElementById('lotSqft').value = report.row[7] || '';
    document.getElementById('lotTemplate').value = report.row[8] || '';
    document.getElementById('lotUnits').value = report.row[9] || '';
    document.getElementById('notes').value = report.row[10] || '';

    document.getElementById('reportForm').dataset.editRow = rowIndex;
    msg.innerText = `Editing row ${rowIndex}`;
    msg.style.color = '#555';
  } catch (err) {
    msg.style.color = 'red';
    msg.innerText = err.toString();
  }
}

async function deleteReport(rowIndex) {
  if (!confirm('Delete this report?')) return;
  const payload = { action: 'delete', rowIndex };
  try {
    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    const data = await res.json();
    msg.style.color = data.ok ? 'green' : 'red';
    msg.innerText = data.message || data.error || 'Delete failed';
    loadMyReports();
  } catch (err) {
    msg.style.color = 'red';
    msg.innerText = err.toString();
  }
}

async function saveReport() {
  const payload = {
    action: 'save',
    username: user,
    date: document.getElementById('date').value,
    noOfFiles: document.getElementById('noOfFiles').value,
    totalSqft: document.getElementById('totalSqft').value,
    dxf: document.getElementById('dxf').value,
    dwg: document.getElementById('dwg').value,
    lotFileNumber: document.getElementById('lotFileNumber').value,
    lotSqft: document.getElementById('lotSqft').value,
    lotTemplate: document.getElementById('lotTemplate').value,
    lotUnits: document.getElementById('lotUnits').value,
    notes: document.getElementById('notes').value,
    editRow: document.getElementById('reportForm').dataset.editRow || null
  };

  try {
    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    const data = await res.json();
    msg.style.color = data.ok ? 'green' : 'red';
    msg.innerText = data.message || data.error || 'Failed to save';
    document.getElementById('reportForm').reset();
    delete document.getElementById('reportForm').dataset.editRow;
    loadMyReports();
  } catch (err) {
    msg.style.color = 'red';
    msg.innerText = err.toString();
  }
}

document.getElementById('submitBtn').addEventListener('click', saveReport);
loadMyReports();
</script>
</body>
</html>
